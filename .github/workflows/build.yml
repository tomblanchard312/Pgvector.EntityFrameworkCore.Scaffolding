# yaml-language-server: $schema=https://json.schemastore.org/github-workflow
name: Build and Release (SLSA L3 aligned)

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]
    tags:
      - "v*.*.*"
  workflow_dispatch: {}

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

defaults:
  run:
    shell: bash

env:
  DOTNET_VERSION: "8.0.418"
  CONFIGURATION: "Release"
  SOLUTION: "Pgvector.EntityFrameworkCore.Scaffolding.sln"
  PROJECT: "Pgvector.EntityFrameworkCore.Scaffolding.csproj"
  ARTIFACT_DIR: "artifacts"
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"

jobs:
  build:
    name: Build, Test, Pack, SBOM, Attest
    runs-on: ubuntu-22.04

    permissions:
      contents: read
      id-token: write
      attestations: write

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Cache NuGet + dotnet tools
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.dotnet/tools
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Set version
        id: version
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
          else
            echo "VERSION=0.0.0-ci.${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"
          fi

      - name: Restore (locked if lock files exist)
        run: |
          if ls **/packages.lock.json >/dev/null 2>&1; then
            dotnet restore "${{ env.SOLUTION }}" --locked-mode
          else
            echo "No packages.lock.json found. Restoring without locked mode."
            dotnet restore "${{ env.SOLUTION }}"
          fi

      - name: Detect dependency drift (PR only)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin main
          if git diff --name-only origin/main | grep -q packages.lock.json; then
            echo "Dependency lock file changed:"
            git diff origin/main -- packages.lock.json
          else
            echo "No dependency changes detected."
          fi

      - name: Build (deterministic)
        run: |
          dotnet build "${{ env.SOLUTION }}" \
            -c "${{ env.CONFIGURATION }}" \
            --no-restore \
            /p:ContinuousIntegrationBuild=true

      - name: Pack
        run: |
          mkdir -p "${{ env.ARTIFACT_DIR }}"
          dotnet pack "${{ env.PROJECT }}" \
            -c "${{ env.CONFIGURATION }}" \
            --no-build \
            -o "${{ env.ARTIFACT_DIR }}" \
            /p:ContinuousIntegrationBuild=true \
            /p:IncludeSymbols=true \
            /p:SymbolPackageFormat=snupkg \
            /p:PackageVersion="${{ steps.version.outputs.VERSION }}"

      - name: Install CycloneDX (pinned)
        run: |
          dotnet tool install --global CycloneDX --version 6.0.0
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Generate SBOM
        run: |
          dotnet-CycloneDX "${{ env.SOLUTION }}" \
            --output "${{ env.ARTIFACT_DIR }}" \
            --json

      - name: Create SHA-256 checksums
        run: |
          cd "${{ env.ARTIFACT_DIR }}"
          sha256sum *.nupkg *.snupkg bom.json > SHA256SUMS.txt

      - name: Attest provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f
        with:
          subject-path: |
            ${{ env.ARTIFACT_DIR }}/*.nupkg
            ${{ env.ARTIFACT_DIR }}/*.snupkg
            ${{ env.ARTIFACT_DIR }}/bom.json
            ${{ env.ARTIFACT_DIR }}/SHA256SUMS.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: nuget-artifacts
          path: ${{ env.ARTIFACT_DIR }}
          if-no-files-found: error

  publish:
    name: Publish to NuGet
    if: ${{ github.ref_type == 'tag' }}
    runs-on: ubuntu-22.04
    needs: [build]

    permissions:
      contents: read

    environment: nuget

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@b14cf4c92620c250e1c074ab0a5800e37df86765
        with:
          name: nuget-artifacts
          path: ${{ env.ARTIFACT_DIR }}

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Verify SHA256
        run: |
          cd "${{ env.ARTIFACT_DIR }}"
          sha256sum -c SHA256SUMS.txt

      - name: Publish
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          dotnet nuget push "${{ env.ARTIFACT_DIR }}/*.nupkg" \
            --api-key "$NUGET_API_KEY" \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
